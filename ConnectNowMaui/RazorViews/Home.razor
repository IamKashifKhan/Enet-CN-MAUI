@using AutoMapper
@using ConnectNow.Services.Local
@using ConnectNow.Views
@using Microsoft.AppCenter
@inject ILocalCache localCache
@inject ICNApiService apiService
@inject ILoginService loginService
@inject IThemeManager themeManager
@inject IJSRuntime JSRuntime
@inject IOfferService offerService
@inject IAppVersion appVersion
@inject ILocationService locationService
@inject IMapper mapper;
@inject IFirstPaintNotifier FirstPaintNotifier
@inject IMapConfig MapConfig


 
    <div class="d-flex flex-column">

        <!-- ============================================================= -->
        <!-- Header (Shared across tabs)                                   -->
        <!-- ============================================================= -->
        <header class="fixed-top d-flex flex-wrap align-items-center justify-content-center justify-content-lg-between shadow py-lg-1">
            <div class="container d-flex flex-row justify-content-between">
                <!-- Logo -->
                <a href="" class="logo d-none d-lg-block mb-2 mb-lg-0">
                    <img src="img/logo-dark.svg" onerror="this.src='img/logo-dark.png'" alt="All About Local" />
                </a>

                <!-- DropDown Categories -->
                <div class="btn-group d-none d-lg-flex align-self-start ms-lg-4 ms-xl-5 mt-auto mb-1">
                    <button class="btn btn-primary btn-sm dropdown-toggle rounded-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        All Categories
                    </button>
                    <ul class="dropdown-menu">
                        <!-- Category items go here -->
                    </ul>
                </div>

                <!-- Bottom / Footer Navigation -->
                <ul class="nav nav-foot d-flex flex-row flex-nowrap flex-lg-wrap justify-content-lg-end align-content-lg-between flex-lg-fill shadow mt-auto mt-lg-0">
                    <li class="d-lg-none">
                        <a href="#"
                           class="@GetNavClass(NavTab.Directory)"
                           @onclick="() => SelectTab(NavTab.Directory)"
                           @onclick:preventDefault>
                            <img src="img/directory.svg" alt="Directory" /> Directory
                        </a>
                    </li>

                    <li>
                        <a href="#"
                           class="@GetNavClass(NavTab.Events)"
                           @onclick="() => SelectTab(NavTab.Events)"
                           @onclick:preventDefault>
                            <img src="img/events.svg" alt="Events" class="me-lg-1" /> Events
                        </a>
                    </li>

                    <li>
                        <a href="#"
                           class="@GetNavClass(NavTab.Favorites)"
                           @onclick="() => SelectTab(NavTab.Favorites)"
                           @onclick:preventDefault>
                            <img src="img/favorites.svg" alt="Favorites" /> Favorites
                        </a>
                    </li>

                    <li>
                        <a href="#"
                           class="@GetNavClass(NavTab.Map)"
                           @onclick="() => SelectTab(NavTab.Map)"
                           @onclick:preventDefault>
                            <img src="img/map.svg" alt="Map" /> Map
                        </a>
                    </li>

                    <li class="d-lg-none">
                        <a href="#"
                           class="@GetNavClass(NavTab.More)"
                           @onclick="() => SelectTab(NavTab.More)"
                           @onclick:preventDefault>
                            <img src="img/more.svg" alt="More" /> More
                        </a>
                    </li>
                </ul>
                <!-- /\ Navigation END /\ -->
            </div>

            <!-- ============================ Mobile Header ============================ -->
            <div id="mob_top" class="d-flex d-lg-none flex-row flex-nowrap justify-content-between align-items-center text-light lh-1 w-100 shadow">
                @* -------- Directory (Mobile) -------- *@
                @if (selectedTab == NavTab.Directory)
                {
                    <div class="mob_top-left invisible"><a href="" class="d-flex fs-5 link-light ms-1 me-1 me-sm-3 p-2"><i class="bi bi-chevron-left"></i></a></div>
                    <div class="mob_top-head visible"><div class="fs-5 text-truncate lh-lg">Popular Categories</div></div>
                    <div class="mob_top-right visible">
                        <div class="d-flex">
                            <a href="" class="link-light p-3" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSearch" aria-controls="offcanvasSearch"><i class="bi bi-search"></i></a>
                            <div id="offcanvasSearch" class="offcanvas offcanvas-top" data-bs-scroll="false" tabindex="-1">
                                <div class="offcanvas-body p-1 px-2">
                                    <button type="button" class="btn-close position-absolute end-0 p-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                                    <form  >
                                        <input id="exampleDataList"
                                               class="form-control fs-5 border-0 bg-transparent py-2"
                                               list="datalistOptions"
                                               placeholder="Search City, Company or Keyword"
                                               enterkeyhint="search"
                                               @bind-value="SearchText"
                                               @bind-value:event="oninput"
                                               @onkeydown="OnSearchKey" />               
                                            <datalist id="datalistOptions">
                                            <option value="Ventura, CA"></option>
                                            <option value="Oxnard, CA"></option>
                                            <option value="Camarillo, CA"></option>
                                            <option value="Ojai, CA"></option>
                                            <option value="Santa Paula, CA"></option>
                                            <option value="Fillmore, CA"></option>
                                            <option value="Newbury Park, CA"></option>
                                            <option value="Thousand Oaks, CA"></option>
                                            <option value="Moorpark, CA"></option>
                                        </datalist>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @* -------- Events (Mobile) -------- *@
                @if (selectedTab == NavTab.Events)
                {
                    <div class="mob_top-left invisible"><a href="" class="d-flex fs-5 link-light ms-1 me-1 me-sm-3 p-2"><i class="bi bi-chevron-left"></i></a></div>
                    <div class="mob_top-head visible"><div class="fs-5 text-truncate lh-lg">Events</div></div>
                }

                @* -------- Favorites (Mobile) -------- *@
                @if (selectedTab == NavTab.Favorites)
                {
                    <div class="mob_top-left invisible"><a href="" class="d-flex fs-5 link-light ms-1 me-1 me-sm-3 p-2"><i class="bi bi-chevron-left"></i></a></div>
                    <div class="mob_top-head visible"><div class="fs-5 text-truncate lh-lg">Favorites</div></div>
                }

                @* -------- Map (Mobile) -------- *@
                @if (selectedTab == NavTab.Map)
                {
                    <div class="mob_top-left invisible"><a href="" class="d-flex fs-5 link-light ms-1 me-1 me-sm-3 p-2"><i class="bi bi-chevron-left"></i></a></div>
                    <div class="mob_top-head visible"><div class="fs-5 text-truncate lh-lg">Maps</div></div>
                }

                @* -------- More (Mobile) -------- *@
                @if (selectedTab == NavTab.More)
                {
                    <div class="mob_top-left invisible"><a href="" class="d-flex fs-5 link-light ms-1 me-1 me-sm-3 p-2"><i class="bi bi-chevron-left"></i></a></div>
                    <div class="mob_top-head visible"><div class="fs-5 text-truncate lh-lg">More</div></div>
                }
            </div>
        </header>

        <!-- ============================================================= -->
        <!-- Main Content                                                  -->
        <!-- ============================================================= -->
        <main class="flex-shrink-0 py-0" style="margin-top: 70px;">
        <div class="container-fluid">

                <!-- ========================================================= -->
                <!-- #region Directory Tab (Markup)                            -->
                <!-- ========================================================= -->
                <div role="tabpanel" class="tab-pane"
                     hidden="@(selectedTab != NavTab.Directory ? "hidden" : null)"
                     aria-hidden="@(selectedTab != NavTab.Directory ? "true" : "false")">
                    <div class="row">

                        @if (_directoryLoadFailed)
                        {
                            <div class="alert alert-danger d-flex align-items-center justify-content-between" role="alert">
                                <span>Failed to load categories. @(_directoryError ?? "Please try again.")</span>
                                <button class="btn btn-sm btn-outline-light" @onclick="RetryDirectoryAsync">Retry</button>
                            </div>
                        }
                        @if (_directoryLoading)
                        {
                            <div class="small text-muted d-flex align-items-center gap-2 mb-2">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Loading categories…</span>
                            </div>
                        }

                        <div class="d-flex flex-wrap gap-lg-4 category-boxes">
                            @* Cities first *@
                            @if (categorylist != null)
                            {
                                foreach (var item in categorylist)
                                {
                                    if (item.Name == "Cities")
                                    {
                                        <CategoryCard Category="item" OnSelected="HandleCategorySelected"></CategoryCard>
                                    }
                                }
                            }

                            <!-- Cities OffCanvas -->
                            <div id="offcanvasCities" class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0 shadow" tabindex="-1" aria-labelledby="offcanvasCitiesLabel">
                                <div class="offcanvas-header">
                                    <h5 id="offcanvasCitiesLabel" class="offcanvas-title">Select Your City</h5>
                                    <button data-bs-dismiss="offcanvas" class="btn-close" type="button" aria-label="Close"></button>
                                </div>
                                <div class="offcanvas-body">
                                    <div class="d-flex flex-row flex-wrap justify-content-start gap-2 pt-2">
                                        @if (CityList != null)
                                        {
                                            @foreach (var city in CityList)
                                            {
                                                <a href="" @onclick:preventDefault @onclick="() => HandleCitySelected(city)" class="btn btn-sm btn-outline-secondary rounded-pill">@city</a>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                            <!-- /Cities OffCanvas -->

                            <h1 class="d-none d-lg-block text-center mb-4">Popular Categories</h1>

                            @if (categorylist == null && !_directoryLoading && !_directoryLoadFailed)
                            {
                                <LoadingCard></LoadingCard>
                            }
                            else if (categorylist != null)
                            {
                                foreach (var item in categorylist)
                                {
                                    if (item.Name != "Cities")
                                    {
                                        <CategoryCard Category="item" OnSelected="HandleCategorySelected"></CategoryCard>
                                    }
                                }
                            }
                        </div>
                    </div>
                </div>
                <!-- #endregion Directory Tab (Markup) -->
                <!-- ========================================================= -->
                <!-- #region Events Tab (Markup)                               -->
                <!-- ========================================================= -->
                <div role="tabpanel" class="tab-pane"
                     hidden="@(selectedTab != NavTab.Events ? "hidden" : null)"
                     aria-hidden="@(selectedTab != NavTab.Events ? "true" : "false")">
                    <div class="row">

                        @if (_eventsLoadFailed)
                        {
                            <div class="alert alert-danger d-flex align-items-center justify-content-between" role="alert">
                                <span>Failed to load events. @(_eventsError ?? "Please try again.")</span>
                                <button class="btn btn-sm btn-outline-light" @onclick="RetryEventsAsync">Retry</button>
                            </div>
                        }
                        @if (_eventsLoading)
                        {
                            <div class="small text-muted d-flex align-items-center gap-2 mb-2">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Loading events…</span>
                            </div>
                        }

                        <!-- Month/Year Button -->
                        <button class="btn btn-sm bg-transparent text-body-emphasis border-0 w-auto mt-0 mb-2"
                                type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMonYrPicker"
                                aria-controls="offcanvasMonYrPicker">
                            <span id="txt_monthYear">@_currentMonthLabel</span>
                            <i class="bi bi-chevron-down"></i>
                        </button>

                        <!-- OffCanvas Month/Year Picker -->
                        <div id="offcanvasMonYrPicker" class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0 px-0 shadow"
                             data-bs-scroll="false" tabindex="-1">
                            <div class="offcanvas-body d-flex flex-column justify-content-between">
                                <div id="selectedPreview" class="fw-bold text-center mb-5"><!-- Dynamic Month Year --></div>
                                <div class="picker-wrapper">
                                    <div class="picker-highlight"></div>
                                    <div id="monthList" class="picker-column"><ul><!-- Dynamic Months --></ul></div>
                                    <div id="yearList" class="picker-column"><ul><!-- Dynamic Years --></ul></div>
                                </div>
                                <div class="container d-flex justify-content-between mt-5">
                                    <button class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                                    <button class="btn btn-outline-secondary" id="savePicker">Save</button>
                                </div>
                            </div>
                        </div>

                        <!-- OwlCarousel Calendar -->
                        <div class="sliding-tabs event-calendar">
                            <div id="owl-tabs" class="owl-carousel owl-theme"></div>
                        </div>



                    </div>

                <div class="container-fluid container-events">
                    <div class="container">
                        <div class="row">

                            <ul class="card-group events-timeline">
                                @if (alleventItems is not null && alleventItems.Count > 0)
                                {
                                    @foreach (var ev in alleventItems)
                                    {
                                        <EventCard Event="ev" OnSelected="HandleEventSelected" />
                                    }
                                }
                                else
                                {
                                    <div class="map-offers-count">No events found nearby</div>
                                }

                            </ul>

                            <button class="btn btn-sm btn-light text-black-50 border rounded-pill w-auto mx-auto mb-4" type="button">Load More Events <i class="bi bi-chevron-up"></i></button>

                        </div>
                    </div>
                </div>
                </div>
                <!-- #endregion Events Tab (Markup) -->
                <!-- ========================================================= -->
                <!-- #region Favorites Tab (Markup)                            -->
                <!-- ========================================================= -->
                <div role="tabpanel" class="tab-pane"
                     hidden="@(selectedTab != NavTab.Favorites ? "hidden" : null)"
                     aria-hidden="@(selectedTab != NavTab.Favorites ? "true" : "false")">
                    <div class="row">
                        <h1 class="d-none d-lg-block text-center fw-normal h1 mb-4">Favorites</h1>

                        @if (_favLoadFailed)
                        {
                            <div class="alert alert-danger d-flex align-items-center justify-content-between" role="alert">
                                <span>Failed to load favorites. @(_favError ?? "Please try again.")</span>
                                <button class="btn btn-sm btn-outline-light" @onclick="() => LoadFavoritesAsync()">Retry</button>
                            </div>
                        }

                        @if (_favLoading && _favoriteOffers.Count == 0)
                        {
                            <div class="small text-muted d-flex align-items-center gap-2 mb-2">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Loading favorites…</span>
                            </div>
                        }

                        <ul class="card-group favorites">
                            @if (_favoriteOffers.Count == 0 && !_favLoading && !_favLoadFailed)
                            {
                                <li class="w-100 text-center py-4 text-muted">
                                    No favorites yet.
                                </li>
                            }
                            else
                            {
                                @foreach (var offer in _favoriteOffers)
                                {
                                    <OfferCard Offer="offer"
                                                isActivePlan="planDetails.IsActive"
                                                OnSelected="HandleOfferSelected"
                                               AddRemoveToFavorite="AddRemoveFav" />
                                }
                            }
                        </ul>

                     
                    </div>
                </div>
                <!-- #endregion Favorites Tab (Markup) -->
                <!-- ========================================================= -->
                <!-- #region Map Tab (Markup)                                  -->
                <!-- ========================================================= -->
                <div role="tabpanel" class="tab-pane flex-shrink-0 map-main"
                     hidden="@(selectedTab != NavTab.Map ? "hidden" : null)"
                     aria-hidden="@(selectedTab != NavTab.Map ? "true" : "false")">
                    <div class="container-fluid map-wrapper">
                             <GoogleMap Width="100%" Height="100%" ApiKey="@MapConfig.GoogleMapsApiKey"
                                       StartLat="StartLat"
                                       StartLng="StartLng"
                                       StartZoom="12"
                                       CssClass="business-map"
                                       OnViewChanged="OnMapChanged"
                                       OnMapPinTapped="OnPinTapped"
                                       @ref="_map" />
                        <div class="maps-over justify-content-end">

                            <!--sliding Offers Cards of maps + NearBy Controls-->
                            <div class="slide-cards">

                                <button class="btn btn-secondary rounded-circle shadow-sm btn-nearby" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNearby" aria-controls="offcanvasNearby"> <img src="img/nearby.svg" alt="" /> </button>

                            <div class="sliding-tabs map-offers">
                                <div id="owl-tabs-map-offers" class="owl-carousel owl-theme card-group"></div>
                            </div>

                            </div>
                        </div>
                        
                     </div>


               


                </div>
                <!-- #endregion Map Tab (Markup) -->
                <!-- ========================================================= -->
                <!-- #region More Tab (Markup - Mobile)                        -->
                <!-- ========================================================= -->
                <div role="tabpanel" class="tab-pane"
                     hidden="@(selectedTab != NavTab.More ? "hidden" : null)"
                     aria-hidden="@(selectedTab != NavTab.More ? "true" : "false")">
                    @if (selectedTab == NavTab.More)
                    {
                        <div class="row">
                            <div class="list-group list-group-flush px-0 py-2">
                                <a href=" " class="list-group-item list-group-item-action  gap-2" @onclick="() => logOut()"><i class="bi bi-person"></i> Logout</a>
                                <a href="" class="list-group-item list-group-item-action d-none gap-2"><i class="bi bi-lock"></i> Create Account</a>
                                <a href=""
                                   class="list-group-item list-group-item-action @(IsManageGridVisible ? "d-flex" : "d-none") gap-2"
                                   @onclick="GotoManageSubscription">
                                    <i class="bi bi-stopwatch"></i> Manage Subscription
                                </a>
                               <a href="" class="list-group-item list-group-item-action d-flex gap-2" @onclick="GotoSignUp"><i class="bi bi-lock"></i> @UserSubscriptionStatus</a>
                                <a href="" class="list-group-item list-group-item-action d-flex gap-2" @onclick="GotoSavingsPage"><i class="bi bi-bookmark-check"></i> My Savings</a>
                                <a href="notifications.html" class="list-group-item list-group-item-action d-none gap-2"><i class="bi bi-bell" @onclick="GotoSavingsPage"></i> Notifications</a>
                                <a href="https://allaboutlocal.com/localmembership" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-people"></i> Local Membership</a>
                                <a href="https://allaboutlocal.com/localadvertising" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-megaphone"></i> Local Advertising</a>
                                <a href="https://allaboutlocal.com/localfundraising" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-cash-coin"></i> Local Fundraising</a>
                                <a href="https://allaboutlocal.com/where-to-buy" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-basket"></i> Where to Buy</a>
                                <a href="//fb.me/Allaboutlocalvc" class="list-group-item list-group-item-action d-flex gap-2" target="_blank"><i class="bi bi-facebook"></i> Our Facebook</a>
                                <a href="//instagr.am/allaboutlocalvc" class="list-group-item list-group-item-action d-flex gap-2" target="_blank"><i class="bi bi-instagram"></i> Our Instagram</a>
                                <a href="https://allaboutlocal.com/about-us" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-at"></i> About Us</a>
                                <a href="tips-help.html" class="list-group-item list-group-item-action d-none gap-2"><i class="bi bi-info-square"></i> Tips &amp; Help</a>
                                <a href="https://allaboutlocal.com/privacy-policy" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-shield-lock"></i> Privacy Statement</a>
                                <a href="https://allaboutlocal.com/terms-of-service" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-journal-text"></i> Terms of Use</a>
                                <a href="" class="list-group-item list-group-item-action d-flex gap-2"><i class="bi bi-journal-text"></i> @AppVersionAndCopyrightText</a>
                            </div>
                        </div>
                    }
                </div>
                <!-- #endregion More Tab (Markup - Mobile) -->
            <!-- OffCanvas Redeem -->
            <div id="offcanvasRedeem" class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0 px-0 shadow"
                 data-bs-scroll="false" tabindex="-1" aria-labelledby="offcanvasRedeemLabel">
                <div class="offcanvas-header">
                    <h5 id="offcanvasRedeemLabel" class="offcanvas-title">
                        @(SelectedOffer?.BusinessName ?? "Selected Offer")
                    </h5>
                    <button data-bs-dismiss="offcanvas" class="btn-close" type="button" aria-label="Close"></button>
                </div>

                <div class="offcanvas-body d-flex flex-column">
                    <div class="offer-top mb-3">
                        @if (SelectedOffer is not null)
                        {
                            <div class="offer-expiry">
                                @if (SelectedOffer.EndDate != default)
                                {
                                    @:Expiry @SelectedOffer.EndDate.ToString("MM-dd-yyyy")
                                }
                            </div>
                            <button class="@(SelectedOffer.isFavorite ? "heart active" : "heart")"
                                    type="button"
                                    disabled="@_favBusy"
                                    @onclick="() => AddRemoveFav(SelectedOffer)">
                            </button>
                        }
                    </div>

                    <div class="card redeem">
                        <h2 class="card-header">@SelectedOffer?.Heading</h2>
                        <div class="card-body">
                            <h6 class="redeem-desc">@SelectedOffer?.Description</h6>
                            <p>Tap Redeem at checkout.</p>

                            @if (!string.IsNullOrWhiteSpace(SelectedOffer?.ThumbnailPath))
                            {
                                <div class="card-img" style="background-image: url('@SelectedOffer.ThumbnailPath');"></div>
                            }

                            <p class="text-muted small mb-0">
                                This coupon is valid only at @(SelectedOffer?.BusinessName ?? "merchant").
                            </p>
                        </div>
                        <div class="card-footer">
                            <a href="#" class="btn btn-primary btn-lg rounded-pill px-5"
                               data-bs-toggle="modal" data-bs-target="#modalRedeemCode">
                                Redeem Offer
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Redeem -->
            <div id="modalRedeemCode" class="modal fade" aria-labelledby="modalRedeemCode" aria-hidden="true" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-body-emphasis">To Redeem this Offer</h5>
                            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Enter code @SelectedOffer.ConfirmationCode to redeem offer at time of checkout </p>
                            <input @bind="Code" class="form-control form-control-lg font-monospace" type="text" minlength="6" maxlength="6" placeholder="Enter Code" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" @onclick="ValidateCode" class="btn btn-primary" data-bs-toggle="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Success -->
            <!--\/Modal "Success" START\/-->
            <div id="modalRedeemSuccess" class="modal fade" aria-labelledby="modalRedeemSuccess" aria-hidden="true" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-body-emphasis">Congrats..! Enjoy..!</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>You have successfully redeemed this offer, thank for your shopping local!</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" @onclick="GotoSavingsPage" data-bs-dismiss="modal">SEE YOUR SAVINGS</button>
                        </div>
                    </div>
                </div>
            </div> <!--/\Modal Success END/\-->
            </div> <!-- /.container -->
        </main>
    </div>
<!--Offcanvas Nearby-->
<div id="offcanvasNearby" class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0 px-0 shadow" data-bs-scroll="false" tabindex="-1">
    <div class="offcanvas-body d-flex flex-column justify-content-between">
        <h5 class="text-center mb-3">Offers in @tempRangeDisplay miles</h5>
        <div class="range-wrapper">
           
            <input id="customRange" class="form-range" type="range" min="1000" max="20000" step="1000" value="@_fixedRadius"
                   @oninput="OnRadiusInput" />
            <output id="rangeValue" for="customRange" aria-hidden="true"></output>
        </div>
        <!-- Buttons -->
        <div class="container d-flex justify-content-between mt-2">
            <button   class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            <button @onclick="OnRangeSave" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Save</button>
        </div>
    </div>
</div> <!--Offcanvas Nearby-->
@code {
    // ======================================================================
    // #region Parameters
    // ======================================================================
    [Parameter] public CategoryItem? category { get; set; }
    [Parameter] public string? CategoryName { get; set; }
    [Parameter] public string? Id { get; set; }
    [Parameter] public double StartLat { get; set; } = 34.197504;
    [Parameter] public double StartLng { get; set; } = -119.177052;
    // #endregion

    // ======================================================================
    // #region Shared Fields & Services
    // ======================================================================
    public AALUser _user { get; set; } = default!;
    private IJSObjectReference? _homejs;
    private DotNetObjectReference<Home>? _self;
    private NavTab selectedTab = NavTab.Directory;
    private DateTime _live = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime _committed = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    string AppVersionAndCopyrightText;
    private string? _currentMonthLabel;

    // Calendar memory (remember only last selected day)
    private string? _lastActiveDateKey; // "yyyy-MM-dd"

    // Common JS module loader
    private async Task EnsureJsModuleAsync()
    {
        if (_homejs is null)
            _homejs = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./RazorViews/Home.razor.js");
        _self ??= DotNetObjectReference.Create(this);
    }
    // #endregion

    // ======================================================================
    // #region Directory Tab (State + Methods)
    // ======================================================================
    private IEnumerable<CategoryItem>? categorylist;
    private List<string>? CityList;
    private bool _directoryLoading;
    private bool _directoryLoadFailed;
    private string? _directoryError;

    private string? SearchText;

    private async Task OnSearchKey(KeyboardEventArgs e)
    {
        // Android "Next"/"Done"/"Search" generally arrives as Enter
        if (e.Key == "Enter")
        {
            await DoSearchAsync(SearchText);
            // optionally prevent the default (e.g., form submit)
            // but only if you also add @onkeydown:preventDefault in the input
        }
    }

    private async  Task DoSearchAsync(string? q)
    {
        var route = $"{nameof(BusinessesPage)}?CategoryId={"Search"},{q}";
        await Shell.Current.GoToAsync(route);
    }

    private async Task GetCities()
    {
        try
        {
            CityList = new List<string>
            {
                "Ventura", "Oxnard", "Camarillo", "Ojai", "Santa Paula", "Fillmore",
                "Newbury Park", "Thousand Oaks", "Moorpark"
            };
        }
        catch { /* ignore */ }
    }

    private async Task GetDirectory()
    {
        _directoryLoading = true;
        _directoryLoadFailed = false;
        _directoryError = null;
        StateHasChanged();

        try
        {
            var categoryRequest = new CategoryRequest();
            var result = await apiService.GetAppMainCategories(categoryRequest);

            if (result.Success)
            {
                var categories = result.Data;

                var diningcategory = categories.FirstOrDefault(x => x.Name == "Dining");
                var bogocategory = categories.FirstOrDefault(x => x.Name == "Bogo");
                var beautyandspa = categories.FirstOrDefault(x => x.Category_Sub_Key == "12");
                var giftCards = categories.FirstOrDefault(x => x.Category_Sub_Key == "21");

                categories.Remove(bogocategory);
                categories.Insert(0, bogocategory);

                categories.Remove(giftCards);
                categories.Insert(1, giftCards);

                categories.Remove(diningcategory);
                categories.Insert(2, diningcategory);

                categories.Remove(beautyandspa);
                categories.Insert(6, beautyandspa);

                categorylist = categories;
            }
            else
            {
                _directoryLoadFailed = true;
                _directoryError = result.Message;
            }
        }
        catch (Exception ex)
        {
            _directoryLoadFailed = true;
            _directoryError = ex.Message;
        }
        finally
        {
            _directoryLoading = false;
            StateHasChanged();
        }
    }

    private Task RetryDirectoryAsync() => GetDirectory();

    private async Task HandleCategorySelected(CategoryItem categoryItem)
    {

        if (categoryItem.Category_Sub_Key == CategoryConstants.CategorySubKeyPerks)
        {
            await Launcher.Default.OpenAsync("https://allaboutlocal.benefithub.com/");
            return;
        }
        var route = RouteHelper.BuildRoute(nameof(BusinessesPage),
        new Dictionary<string, string>
        {
            { "CategoryId", $"{categoryItem.Category_Sub_Key},{categoryItem.Name}" }
        });
        await Shell.Current.GoToAsync(route);

    }

    private async Task HandleCitySelected(string CityName)
    {

        var route = RouteHelper.BuildRoute(nameof(BusinessesPage),
        new Dictionary<string, string>
        {
            { "CategoryId", $"City,{CityName}" }
        });

        await Shell.Current.GoToAsync(route);
    }

    private async Task HandleBusinessSearch(string SearchTerm)
    {
        var route = RouteHelper.BuildRoute(nameof(BusinessesPage),
          new Dictionary<string, string>
           {
                { "CategoryId", $"Search,{SearchTerm}" }
           });
        await Shell.Current.GoToAsync(route);
    }
    // #endregion

    // ======================================================================
    // #region Events Tab (State + Methods)
    // ======================================================================
    private List<EventItem>? alleventItems;
    private List<EventItem>? eventItems;
    private bool _eventsLoading;
    private bool _eventsLoadFailed;
    private string? _eventsError;
    private bool _isPickerSet;

    public async Task getEvents(DateTime dateTime)
    {
        _eventsLoading = true;
        _eventsLoadFailed = false;
        _eventsError = null;
        StateHasChanged();

        try
        {


            var eventRequest = new EventRequest(App.CurrentUser.UserKey.ToString());
            var result = await apiService.GetEvents(eventRequest);

            if (result.Success)
            {
                alleventItems = result.Data.OrderBy(o => o.EventStart).ToList();

                eventItems = alleventItems
                    .Where(m => m.EventStart.Month == dateTime.Month && m.EventStart.Year == dateTime.Year)
                    .OrderBy(o => o.EventStart)
                    .ToList();

                if (selectedTab == NavTab.Events)
                {
                    var selected = GetLastSelectedDateOrToday();
                    await InitCalendarAsync(selected, force: true);
                }
            }
            else
            {
                _eventsLoadFailed = true;
                _eventsError = result.Message;
            }
        }
        catch (Exception ex)
        {
            _eventsLoadFailed = true;
            _eventsError = ex.Message;
        }
        finally
        {
            _eventsLoading = false;
            StateHasChanged();
        }
    }

    private Task RetryEventsAsync() => getEvents(DateTime.Today);

    private DateTime GetLastSelectedDateOrToday()
        => DateTime.TryParse(_lastActiveDateKey, out var parsed) ? parsed : DateTime.Today;

    /// <summary>Initialize the Month/Year picker + Owl calendar.</summary>
    private async Task InitCalendarAsync(DateTime targetDate, bool force = false)
    {
        await EnsureJsModuleAsync();
        if (!_isPickerSet)
        {
            await _homejs.InvokeVoidAsync("initMonthYearPicker", new
            {
                containerId = "offcanvasMonYrPicker",
                monthListId = "monthList",
                yearListId = "yearList",
                previewId = "selectedPreview",
                headerId = "txt_monthYear",
                liHeight = 44,
                buffer = 20,
                yearRange = 100,
                initialMonth = _committed.Month,
                initialYear = _committed.Year
            }, _self);
            await _homejs.InvokeVoidAsync("initToday", "#today", DateTime.Now);
            _isPickerSet = true;
        }

        var dateKey = targetDate.ToString("yyyy-MM-dd");
        var monthKey = new DateTime(targetDate.Year, targetDate.Month, 1).ToString("yyyy-MM-dd");

        var eventsThisMonth = (alleventItems ?? new List<EventItem>())
            .Where(e => e.EventStart.Year == targetDate.Year && e.EventStart.Month == targetDate.Month)
            .Select(e => e.EventStart.ToString("yyyy-MM-dd"))
            .Distinct()
            .ToArray();

        await _homejs!.InvokeVoidAsync("InitOwlCalendar", "#owl-tabs", monthKey, eventsThisMonth, dateKey);
        _lastActiveDateKey = dateKey;
    }

    private async  Task HandleEventSelected(EventItem e)
    {
        await localCache.SaveItemInCache(StringConstants.SelectedEvent, e);
        var route = RouteHelper.BuildRoute(nameof(EventDetailPage),
          new Dictionary<string, string>
          {
                { "EventName", $"{e.Name}" }
          });
        await Shell.Current.GoToAsync(route);
    }

    // #endregion

    // ======================================================================
    // #region Favorites Tab (State + Methods)
    // ======================================================================
    private List<BusinessOfferItem> _favoriteOffers = new();
    private bool _favLoading;
    private bool _favLoadFailed;
    private bool isActivePlan;
    private string? _favError;
    private bool _favBusy;
    private BusinessOfferItem? SelectedOffer = new();
    public string Code { get; set; } = string.Empty;

    private async Task LoadFavoritesAsync(bool append = false)
    {
        if (_favLoading) return;

        _favLoading = true;
        _favLoadFailed = false;
        _favError = null;
        StateHasChanged();

        try
        {
            var req = new OffersFavoriteRequest(App.CurrentUser.UserKey.ToString());
            var result = await apiService.GetFavoriteOffers(req);

            if (result.Success)
            {
                var incoming = result.Data;
                _favoriteOffers = incoming.ToList();
            }
            else
            {
                _favLoadFailed = true;
                _favError = result.Message;
            }
        }
        catch (Exception ex)
        {
            _favLoadFailed = true;
            _favError = ex.Message;
        }
        finally
        {
            _favLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddRemoveFav(BusinessOfferItem offer)
    {
        if (_favBusy) return;
        _favBusy = true;
        try
        {
            var response = await offerService.ToggleOfferFavoriteAsync(offer.BusinessOffersKey, _user.UserKey);

            if (response.Success)
                _favoriteOffers.RemoveAll(o => o.BusinessOffersKey == offer.BusinessOffersKey);
        }
        catch { }
        finally
        {
            _favBusy = false;
            StateHasChanged();
        }
    }

    private async Task HandleOfferSelected(BusinessOfferItem offer)
    {
        SelectedOffer = offer;
        StateHasChanged();
        await EnsureJsModuleAsync();
        await _homejs!.InvokeVoidAsync("showOffcanvas", "#offcanvasRedeem");
    }

    private async void ValidateCode()
    {
        var redeedmOfferRequest = new RedeemOfferRequest(App.CurrentUser.UserKey.ToString(), SelectedOffer.BusinessOffersKey.ToString(), Code);
        var output = await apiService.RedeemOffer(redeedmOfferRequest);
        if (output.Success)
        {
            _homejs?.InvokeVoidAsync("showHideModal", true);
        }
    }

    private async void GotoSavingsPage()
    {
        await Shell.Current.GoToAsync(nameof(MySavingsPage));
    }
    // #endregion

    // ======================================================================
    // #region Map Tab (State + Methods)
    // ======================================================================
    private GoogleMap? _map;
    private int _fixedRadius = 1000; // meters

    List<OffersMapItem> AllMapOffersItems = new();
    List<BusinessItem> AllMapBusinessItems = new();

    List<BusinessItem> CurrentShowingMapOffersItems = new();

    public async Task GetMapOffers(string radius, string lat, string lng)
    {
        try
        {
            AllMapOffersItems = await localCache.GetCacheItem<List<OffersMapItem>>(StringConstants.MapOfferItems);
            // if(AllMapOffersItems != null)
            // {
            //     await UpdateMapListItemsAsync(new Location { Latitude = 34.27851, Longitude = -119.16 }, double.Parse(radius) / 1000);
            // }



            if (App.MyPosition == null)
            {
                App.MyPosition = new Location { Latitude = 34.27851, Longitude = -119.16 };
                // Or: App.MyPosition = await locationService.GetCurrentLocationAsync();
            }

            // ✅ Fix: use (lat, lng), not (lat, lat)
            await LockCircleAt(App.MyPosition.Latitude, App.MyPosition.Longitude);

            var offerMapRequest = new OfferMapRequest(lat, lng, radius, App.CurrentUser.UserKey.ToString());
            var output = await apiService.GetMapOffers(offerMapRequest);

            if (output.Success)
            {
                AllMapOffersItems = new List<OffersMapItem>(output.Data);

                await localCache.SaveItemInCache(StringConstants.MapOfferItems, output.Data);


            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message); // log it
        }
    }


    private async Task GetandSetPins()
    {
        try
        {
            AllMapBusinessItems = await localCache.GetCacheItem<List<BusinessItem>>(StringConstants.MapBusinessItems);
            if (AllMapBusinessItems!=null)
            {
                await UpdateMapListItemsAsync(new Location { Latitude = App.MyPosition.Latitude, Longitude = App.MyPosition.Longitude }, (_fixedRadius) / 1000);

            }

            var businessMapRequest = new BusinessMapRequest();
            var output = await apiService.GetAppBusinessesMap(businessMapRequest);
            // foreach (var item in output.Data)
            // {
            //     var offerlabel = (item.ActiveOffersCount > 1) ? "offers" : "offer";
            //     Console.WriteLine($"Business key is {item.BusinessKey} and Buisenesname is {item.Name}");
            //     // Pin pin = new Pin
            //     // {
            //     //     AutomationId = item.BusinessKey.ToString(),
            //     //     Label = item.Name,
            //     //     Address = $"{item.ActiveOffersCount} {offerlabel}",
            //     //     Type = PinType.Place,
            //     //     Position = new Position((double)item.Latitude, (double)item.Longitude)

            //     // };
            //     // pin.InfoWindowClicked += Pin_InfoWindowClicked;
            //     // MyMap.Pins.Add(pin);

            // }
            AllMapBusinessItems = new List<BusinessItem>(output.Data);  
            await localCache.SaveItemInCache(StringConstants.MapBusinessItems, output.Data);


            // Position position = new Position(34.27401980980908, -119.22682399792073);
            // MyMap.MoveToRegion(MapSpan.FromCenterAndRadius(position, Distance.FromKilometers(5)));
            await UpdateMapListItemsAsync(new Location { Latitude = App.MyPosition.Latitude, Longitude = App.MyPosition.Longitude }, (_fixedRadius) / 1000);

        }
        catch (Exception ex)
        {
            Console.WriteLine($"{ex.Message}");
        }

    }

    private async Task GetCurrentLocation()
    {
        var position = await locationService.GetCurrentLocationAsync();
        if(position != null){
            App.MyPosition =  position;
        }
        else {
            App.MyPosition = new Location { Latitude = 34.27851, Longitude = -119.16 };
        }
         Console.WriteLine($"Current location: {App.MyPosition.Latitude}, {App.MyPosition.Longitude}");
    }

    private bool _mapOffersLoading;
    private bool _needsCarouselRebuild;

    private async Task UpdateMapListItemsAsync(Location center, double radiusKm)
    {
        if (_mapOffersLoading) return;
        _mapOffersLoading = true;
        if (AllMapBusinessItems == null) return;
        var radiusMeters = radiusKm * 1000.0;

        var filtered = AllMapBusinessItems
            .Where(x => TryMakeLocation(x, out var offerLoc)
                     && locationService.IsOfferInRange(offerLoc, center, radiusMeters))
            .ToList();

        // CurrentShowingMapOffersItems = new List<BusinessItem>();
        // await Task.Delay(100); // allow UI to update "no offers" before heavy work
        CurrentShowingMapOffersItems = filtered;

        // map pins (optional)
        if (_map is not null)
        {
            await _map.ClearMarkersAsync();
            if (CurrentShowingMapOffersItems.Count > 0)
                await AddMapMarkers(CurrentShowingMapOffersItems);
         
        }

        _needsCarouselRebuild = true;
        StateHasChanged();
        _mapOffersLoading = false;
    }

    private static bool TryMakeLocation(BusinessItem item, out Location loc)
    {
        loc = default!;
        if (item == null) return false;

        if (!TryToDouble(item.Latitude, out var lat)) return false;
        if (!TryToDouble(item.Longitude, out var lng)) return false;

        loc = new Location(lat, lng);
        return true;

        static bool TryToDouble(object? v, out double d)
        {
            switch (v)
            {
                case double dd: d = dd; return true;
                case float ff: d = ff; return true;
                case decimal mm: d = (double)mm; return true;
                case int ii: d = ii; return true;
                case long ll: d = ll; return true;
                case string s: return double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out d);
                default: d = 0; return false;
            }
        }
    }

    // Lock the circle center and apply current radius
    private async Task LockCircleAt(double lat, double lng)
    {
        if (_map is null) return;

        await _map.SetFixCenterAsync(lat, lng);      // ✅ correct mapping
        await _map.SetRadiusAsync(_fixedRadius);     // triggers center + fit in JS
        // You can skip manual zoom; JS fit handles it
    }

    int tempRange;
    string tempRangeDisplay => (tempRange / 1000).ToString();
    private async Task OnRadiusInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var m))
        {
            tempRange = m;
            StateHasChanged();
        }
    }


    private async Task OnRangeCancel()
    {
        if (_map is not null)
        {
            // revert the circle to last known good state
            await _map.SetRadiusAsync(_fixedRadius);
        }
    }
    private async Task OnRangeSave()
    {
        _fixedRadius = tempRange;
        if (_map is not null)
        {
            // 1) update the circle/zoom in JS
            await _map.SetRadiusAsync(_fixedRadius);

            // 2) filter list in C# using the SAME circle numbers
            if (App.MyPosition != null)
            {
                await UpdateMapListItemsAsync(App.MyPosition, _fixedRadius / 1000.0);
            }
        }
    }

    // Receives actual circle center + radius from JS every idle
    private Task OnMapChanged(GoogleMap.MapViewChangedArgs args)
    {
        // If you want to filter strictly by the rendered circle, use:
        // var circleCenter = new Location(args.CircleCenterLat, args.CircleCenterLng);
        // var radiusMeters = args.CircleRadiusMeters;
        // _ = UpdateMapListItemsAsync(circleCenter, radiusMeters / 1000.0);

        return Task.CompletedTask;
    }
    private async Task OnPinTapped(int businessKey)
    {
        var OffersList = AllMapOffersItems.Where(x => x.BusinessKey == businessKey).ToList();
        await setoffersCarousel(OffersList);

     }

    private async Task AddMapMarkers(List<BusinessItem> offersMapItems)
    {
        if (offersMapItems is null || _map is null) return;
        await _map.ClearMarkersAsync();

        foreach (var item in offersMapItems)
        {
            if (item.Latitude != null && item.Longitude != null)
            {
                double lat = Convert.ToDouble(item.Latitude, System.Globalization.CultureInfo.InvariantCulture);
                double lng = Convert.ToDouble(item.Longitude, System.Globalization.CultureInfo.InvariantCulture);

                // (lat, lng, title, iconUrl)
                await _map.AddMarkerAsync(lat, lng, item.BusinessKey, item.Name, item.ActiveOffersCount.ToString());
            }
        }

        // Keep the circle/zoom as the UX anchor:
        await _map.SetRadiusAsync(_fixedRadius);
    }


    // [JSInvokable]
    // public Task<List<OffersMapItem>> GetOffersForRadius(double radiusMeters)
    //   => Task.FromResult(FilterOffers(radiusMeters));

    [JSInvokable] public Task OnOfferRedeem(OffersMapItem offer) => HandleMapOfferSelected(offer);
    [JSInvokable] public Task OnOfferSelected(OffersMapItem offer) { /* open offcanvas / focus map */ return Task.CompletedTask; }
    [JSInvokable] public Task OnRangeResultCount(int count) { /* optional */ return Task.CompletedTask; }
    <!-- ========================================================= -->
    <!-- #region More Tab (Method  - State)                        -->
    <!-- ========================================================= -->
    private PlanDetails planDetails;
    public bool IsManageGridVisible = false;
    public string UserSubscriptionStatus { get; set; } = string.Empty;

    private string AccountActivationVerbage = "Gain all the benefits, activate your account now.";

    private async Task GetSubscription()
    {
        try
        {
            var userSubscriptionPlanRequest = new UserSubscriptionPlanRequest(App.CurrentUser.UserKey);
            var output = await apiService.AppUsersActiveSubscription(userSubscriptionPlanRequest);
            if (output.Success && output.Data != null && output.Data.Count > 0)
            {
                planDetails = output.Data[0];
                 await localCache.SaveItemInCache<PlanDetails>(LocalCacheKeys.PlanDetails, output.Data[0]);
                Preferences.Default.Set(StringConstants.IsPlanActive, output.Data[0].IsActive);
 
                if (planDetails.IsActive)
                {
                    UserSubscriptionStatus = $"Current Plan is {planDetails.PlanName}";
                    IsManageGridVisible = true;
                }
                else
                {
                    IsManageGridVisible = false;
                    UserSubscriptionStatus = AccountActivationVerbage;
                }
            }
            else
            {
                UserSubscriptionStatus = AccountActivationVerbage;
            }
        }
        catch (Exception ex)
        {

        }
        finally
        {
            StateHasChanged();
        }
    }

    private async void GotoEComerce()
    {
        if (planDetails != null && !planDetails.IsActive)
        {

            // NavigationParameters keyValuePairs = new NavigationParameters();
            // keyValuePairs.Add("FromMore", "FromMore");
            // var result = await NavigationService.NavigateAsync(nameof(SignUpPlansPage), keyValuePairs);
        }
    }

    private async void GotoSignUp()
    {
        if (planDetails != null && !planDetails.IsActive)
        {
            var route = RouteHelper.BuildRoute(nameof(SignUpPlanPage),
             new Dictionary<string, string>
             {
                    { "NavigateFrom", $"fromMore" }
             });

            await Shell.Current.GoToAsync(route);
            // NavigationParameters keyValuePairs = new NavigationParameters();
            // keyValuePairs.Add("FromMore", "FromMore");
            // var result = await NavigationService.NavigateAsync(nameof(SignUpPlansPage), keyValuePairs);
        }
    }
    private async void GotoManageSubscription()
    {
        await Shell.Current.GoToAsync(nameof(ManageSubscriptionPage));
    }



    <!-- ========================================================= -->
    <!-- #region End  More Tab (Markup - Mobile)                        -->
    <!-- ========================================================= -->

    // ======================================================================
    // #region Lifecycle
    // ======================================================================
    protected override void OnInitialized()
    {
        var theme = Preferences.Get(StringConstants.UserTheme, null);
        tempRange = 1000;
        themeManager.UpdateAppTheme(
            string.IsNullOrEmpty(theme) ? AppTheme.Unspecified : (theme == "dark" ? AppTheme.Dark : AppTheme.Light)
        );

        WeakReferenceMessenger.Default.Register<RefreshFavorites>(this, (r, m) => { LoadFavoritesAsync(); });
        WeakReferenceMessenger.Default.Register<UpdatePlaneDetails>(this, (r, m) => { GetSubscription(); });
        _ = InitializeAsync();
    }


    private async Task InitializeAsync()
    {
      
         // Set initial position to start location
        App.MyPosition = new Location { Latitude = StartLat, Longitude = StartLng };
         planDetails =  await localCache.GetCacheItem<PlanDetails>(LocalCacheKeys.PlanDetails);
         await GetCurrentLocation();

        App.CurrentUser = await localCache.GetCacheItem<AALUser>(StringConstants.CurrentUser);

        _user = App.CurrentUser;

        AppVersionAndCopyrightText =
            string.Format("App version: {0}({1}) | © {2} All About Local",
                appVersion.GetVersion(), appVersion.GetBuild(), DateTime.Now.Year);

        var loadCities = GetCities();
        var loadDirectory = GetDirectory();
        var loadEvents = getEvents(DateTime.Today);
        var loadFavorites = LoadFavoritesAsync();
        // var loadMapBuisness = GetandSetPins();// GetandSetPins("10000", "34.27851", "-119.16");
        var loadMapOffers = GetMapOffers("1000", StartLat.ToString(), StartLng.ToString());
        var getsubscription = GetSubscription();
         _currentMonthLabel = DateTime.Now.ToString("MMMM yyyy");
        GetandSetPins();
        await Task.WhenAll(loadCities, loadDirectory, loadEvents, loadFavorites, loadMapOffers);

     }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_pendingCalendarDate.HasValue && selectedTab == NavTab.Events)
        {
            var d = _pendingCalendarDate.Value;
            _pendingCalendarDate = null;

            await Task.Yield();
            await InitCalendarAsync(d, force: true);
        }
        if (firstRender)
            FirstPaintNotifier.Raise();   // tell MAUI "first render happened"
     

        if (!firstRender) return;
    }
    // #endregion

    // ======================================================================
    // #region Navigation & Helpers
    // ======================================================================
    private string GetNavClass(NavTab tab)
        => $"nav-link d-flex flex-column flex-lg-row justify-content-between align-items-center row-gap-1 column-gap-lg-1 pb-lg-2 px-0 px-lg-2 {(selectedTab == tab ? "active" : "")}";

    private DateTime? _pendingCalendarDate;
    private bool _calendarReady;

    private void SelectTab(NavTab tab)
    {
        if (selectedTab == tab) return;

        selectedTab = tab;
        StateHasChanged();

        if (tab == NavTab.Events)
        {
            if (!_calendarReady)
            {
                var date = GetLastSelectedDateOrToday();
                _ = InitCalendarAsync(date, force: true);  // first-time init only
                _calendarReady = true;
            }
        }
        // if(tab == NavTab.Map)
        // {
        //     _ = setoffersCarousel();
        // }

    }
  
    private async Task setoffersCarousel(List<OffersMapItem> offersMapItems)
    {
        await EnsureJsModuleAsync();
      //  await _homejs!.InvokeVoidAsync("owlCarouselstart"); // defaults to #owl-tabs-offers
        await _homejs.InvokeVoidAsync("initOffersCarousel", "#owl-tabs-map-offers", _self);
         var isActivePlan = Preferences.Default.Get(StringConstants.IsPlanActive, true);
        await _homejs.InvokeVoidAsync("updateOffersCarousel", offersMapItems, isActivePlan);
    }

    private async Task logOut()
    {
        // Simulate an exception that can be caught

        Preferences.Default.Set(StringConstants.IsUserLoggedIn, false);
        await localCache.SaveItemInCache<AALUser>(StringConstants.CurrentUser, new AALUser());
        await localCache.ClearAllAsync();
 
        await Shell.Current.GoToAsync("//LoginPage");
    }

    private enum NavTab { Directory, Events, Favorites, Map, More }
    // #endregion

    // ======================================================================
    // #region JS Interop Callbacks
    // ======================================================================
    [JSInvokable]
    public Task OnMonthYearChanged(int month1To12, int year)
    {
        _live = new DateTime(year, month1To12, 1);
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public async Task OnMonthYearSaved(int month1To12, int year)
    {
        _committed = new DateTime(year, month1To12, 1);

        var monthKey = new DateTime(year, month1To12, 1).ToString("yyyy-MM-dd");
        var activeKey = _lastActiveDateKey ?? monthKey;

        var eventsThisMonth = (alleventItems ?? new List<EventItem>())
            .Where(e => e.EventStart.Year == year && e.EventStart.Month == month1To12)
            .Select(e => e.EventStart.ToString("yyyy-MM-dd"))
            .Distinct()
            .ToArray();

        await _homejs!.InvokeVoidAsync("UpdateOwlForMonth", "#owl-tabs", monthKey, eventsThisMonth, activeKey);
        StateHasChanged();
    }
    // #endregion

    public void Dispose() => _self?.Dispose();
    private async Task HandleMapOfferSelected(OffersMapItem args)
    {
        BusinessOfferItem mappedOffer = mapper.Map<BusinessOfferItem>(args);
        SelectedOffer = mappedOffer;
        StateHasChanged();
        await EnsureJsModuleAsync();
        await _homejs!.InvokeVoidAsync("showOffcanvas", "#offcanvasRedeem");
    }
}
