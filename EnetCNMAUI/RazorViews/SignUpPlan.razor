@inject IJSRuntime JSRuntime
@using EnetCNMAUI.Domain.Models.MVC
@using EnetCNMAUI.Models
@using EnetCNMAUI.Views
@using Plugin.Firebase.CloudMessaging;
@inject EmailRegistrationRequestValidator emailValidator
@inject ICNApiService apiService
@inject ILocalCache localCache

<div id="app">
  <div class="d-flex flex-column">

    <!--\/header START\/-->
    <header class="fixed-top d-flex flex-wrap align-items-center justify-content-center justify-content-lg-between shadow py-lg-1">
      <div class="container d-flex flex-row justify-content-between">

        <!--\/LOGO START\/-->
        <a href="" class="logo d-none d-lg-block mb-2 mb-lg-0">
          <img src="img/logo-dark.svg" onerror="this.src='img/logo-dark.png'" alt="All About Local" style="height: 42px;" />
        </a> <!--/\LOGO END/\-->

        <!--\/DropDown Categories START\/-->
        <div class="btn-group d-none d-lg-none align-self-start ms-lg-4 ms-xl-5 mt-auto mb-1">
          <button class="btn btn-primary btn-sm dropdown-toggle rounded-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">All Categories</button>
        </div> <!--/\DropDown Categories END/\-->

        <!--\/Navigation START\/-->
        <ul class="nav nav-foot d-flex flex-row flex-nowrap flex-lg-wrap justify-content-lg-end align-content-lg-between flex-lg-fill shadow mt-auto mt-lg-0">
          <li class="d-none d-lg-none">
            <a href="" class="nav-link d-flex flex-column flex-lg-row justify-content-between align-items-center column-gap-1 pb-1 pb-lg-2 px-2"> <img src="img/directory.svg" alt="Directory" /> Directory</a>
          </li>
          <li class="d-none d-lg-none">
            <a href="" class="nav-link d-flex flex-column flex-lg-row justify-content-between align-items-center column-gap-1 pb-1 pb-lg-2 px-2"> <img src="img/events.svg" alt="Events" class="me-lg-1" /> Events</a>
          </li>
          <li class="d-none d-lg-none">
            <a href="" class="nav-link d-flex flex-column flex-lg-row justify-content-between align-items-center column-gap-1 pb-1 pb-lg-2 px-2"> <img src="img/favorites.svg" alt="Favorites" /> Favorites</a>
          </li>
          <li class="d-none d-lg-none">
            <a href="" class="nav-link d-flex flex-column flex-lg-row justify-content-between align-items-center column-gap-1 pb-1 pb-lg-2 px-2"> <img src="img/map.svg" alt="Map" /> Map</a>
          </li>
          <!--\/More DropUp START\/-->
          <li class="d-none d-lg-none dropup">
            <a href="" class="nav-link text-decoration-none dropdown-toggle d-flex flex-column flex-lg-row justify-content-between align-items-center column-gap-1 pb-1 pb-lg-2 px-2" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMore" aria-controls="offcanvasMore"> <img src="img/more.svg" alt="More" /> More</a>
            <div id="offcanvasMore" class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0" tabindex="-1">
            </div>
          </li> <!--/\More DropUp END/\-->
          <li class="d-none d-lg-block"><a href="login.html" class="nav-link px-2"> <i class="bi bi-person"></i> Login</a></li>
          <li class="d-none d-lg-none mx-2"><a href="register.html" class="btn btn-primary btn-sm align-self-center rounded-3 px-3">Create Account</a></li>
          <li class="d-none d-lg-block ms-2 me-1">
            <input id="darkModeButton" type="checkbox" class="btn-check" checked />
            <label class="btn btn-dark" for="darkModeButton"></label>
          </li>
      
        </ul> <!--/\Navigation END/\-->

      </div> <!--/\.container/\-->
      <!--\/Mobile TOP START\/-->
      <div id="mob_top" class="d-flex d-lg-none flex-row flex-nowrap justify-content-between align-items-center text-light lh-1 w-100 shadow">
        <a href="register.html" class="d-flex fs-5 link-light ms-1 me-3 p-2" @onclick="GoBack"> <i class="bi bi-chevron-left"></i> </a>
        <div class="d-none fs-4 text-center text-truncate lh-lg me-auto">Subscription Plans</div>
        <div class="d-none">
          <a href="" class="link-light mx-1 p-3" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSearch" aria-controls="offcanvasSearch"> <i class="bi bi-search"></i> </a>
          <div id="offcanvasSearch" class="offcanvas offcanvas-top" tabindex="-1">
            <div class="offcanvas-body p-1 px-2">
              <button type="button" class="btn-close position-absolute end-0 me-1 p-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
             
            </div>
          </div>
        </div>
      </div> <!--/\Mobile TOP END/\-->
    </header> <!--/\header END/\-->
 
    <!--\/main content START\/-->
    <main class="flex-shrink-0 mb-0">
      <div class="container-fluid">

        <div class="row justify-content-center">
          <div class="col-lg-5 d-none d-lg-block vh-100 bg-no-repeat bg-size-cover bg-position-center p-0" style="background-image:url('img/login-bg.jpg');"></div>
          <div class="col-lg-7 d-flex align-items-center vh-100">
            <div class="card shadow-none border-0 ms-auto me-auto login-card">
              <div class="card-body text-left pt-0">
                <h3 class="login d-block d-lg-block mb-2">Subscription Plans</h3>

                                <small class="d-block text-center mb-2">Option for School Fundraiser Support below</small>
                                <div class="form-floating mb-4">
                                    <select class="form-select"
                                            @bind-Value="SelectedSchool"
                                            @bind-Value:event="onchange">
                                        <option value="" selected disabled>Select any School</option>
                                        @if (ReferralList != null && ReferralList.Count>0)
                                        @foreach (var item in ReferralList)
                                        {
                                            <option value="@item.ReferralName">@item.ReferralName</option>
                                        }
                                     
                                    
                                    </select>
                                    <label>Choose an Option</label>
                                    <div class="dropdown-select"></div>
                                </div>
 
                <form id="" class="" action="" method="">
                  <small class="d-block text-center mb-2">If you have a member code, please enter it now!</small>
                  <div class="input-group mb-4">
                    <div class="form-floating">
                      <input @bind=MemberShipCode id="memberCode" class="form-control" type="text" placeholder="Member Code:" />
                      <label for="memberCode">Member Code:</label>
                    </div>
                    <button @onclick="ValidateMembershipCode" id="button-addon2" class="btn btn-secondary px-4" type="button">Apply</button>
                  </div>

                  <small class="d-block text-center fw-bold fs-6 mb-2">or</small>
                  <small class="d-block text-center mb-2">Select your subscription below</small>

                 @foreach (var item in PlanItems)
                 {
                     <EnetCNMAUI.RazorViews.Cards.PlanCard PlanItem="item" OnChange="HandleChange"></EnetCNMAUI.RazorViews.Cards.PlanCard>
                 }


                  <div class="form-group mt-3 mb-0">
                                        <a href="register-success.html" class="btn btn-light text-black-50" @onclick="GotoRegisterationSuccess" role="button">Skip to FREE Account</a>
                    <input type="submit" name="submit" class="btn btn-secondary float-right" @onclick="GotoEcommerce" value="Next" />
                  </div>

                                  
                </form>

              </div>
            </div>
          </div>
        </div>

      </div>
    </main> <!--/\main content END/\-->

 
  </div>
</div>

@code {
    [Parameter]
    public string? NavigateFrom { get; set; }
    [Parameter]
    public string? CategoryId { get; set; }

    private IJSObjectReference? signUpPlanJsRefernce;
    private DotNetObjectReference<SignUpPlan>? signUpPlanDotnetReference;
    public List<UserSubscriptionPlaneItem> PlanItems = new();
    public List<ReferralItem> ReferralList = new();


    public string SelectedPlanKey; 

    public string MemberShipCode;

    private string? _selectedSchool = "";
    public string? SelectedSchool
    {
        get => _selectedSchool;
        set
        {
            if (_selectedSchool == value) return;
            _selectedSchool = value;
            OnSchoolChanged(_selectedSchool);
        }
    }

    private async  void OnSchoolChanged(string? school)
    {
        App.CurrentUser.Referral = school.ToString();
        var userrequest = new UpdateUserRequest(App.CurrentUser);
        var result = await apiService.UpdateUserBio(userrequest);
        if(result.Success && result.Data != null)
        {
            
        }
        else
         {
             // Handle the error case
         }
        // Your logic here
        // e.g., StateHasChanged(); or call a service
    }
    // private void OnSchoolChanged(ChangeEventArgs e)
    // {
    //     SelectedSchool = e.Value?.ToString();
    //     // you can add extra logic here
    // }

    protected override async Task OnInitializedAsync()
    {
        // signUpPlanJsRefernce = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./RazorViews/SignUpPlan.razor.js");
        // await JSRuntime.InvokeVoidAsync("Helpers.setDotNetHelper", DotNetObjectReference.Create(this));
        var ghgg = NavigateFrom;
        var ggg = CategoryId;
        //signUpPlanDotnetReference = DotNetObjectReference.Create(this);
        GetPlans();

        GetSchoolsList();   

        // await registrationByPhoneJsRefernce.InvokeVoidAsync("setPasswordViewToggle");

        base.OnInitialized();
    }

    private async void GetSchoolsList()
    {
        
		var refererralRequest = new GetAllReferralRequest();
         var apiResult = await apiService.GetAllReferralList(refererralRequest);

         if (apiResult.Success && apiResult.Data != null)
         {
             ReferralList = apiResult.Data;
			StateHasChanged();
         }
         else
         {
             // Handle the error case
	  	}
    
    
    }
    private async  void GetPlans()
    {
        try
        {
            ApiResult<List<UserSubscriptionPlaneItem>> apiResult = null;
            apiResult = await this.apiService.GetAppUserSubscriptionPlans(new GetPlanRequest(string.Empty, "1"));
            var PlanItemsfromServer = apiResult.Data;
            PlanItemsfromServer = PlanItemsfromServer.OrderBy(x => x.BillingCycle).ToList();
            PlanItemsfromServer = PlanItemsfromServer.Where(x => x.isOffersOnly == false).ToList();
            foreach (var item in PlanItemsfromServer)
            {
                switch (item.BillingCycle)
                {
                    case 1:
                        item.ImagePath = "monthly";
                        item.HeadingText = $"Monthly - ${item.Fee} ";
                        item.DescriptionText = $"${item.Fee * 12} Annually";

                        break;
                    case 12:
                        item.ImagePath = "bi_annual";
                        item.HeadingText = $"Annual - ${item.Fee} ";
                        item.DescriptionText = $"The Best Value";
                        break;
                    case 6:
                        item.ImagePath = "annual";
                        item.HeadingText = $"Bi-Annual - ${item.Fee} ";
                        item.DescriptionText = $"${item.Fee * 2} Annually";
                        break;
                    default:
                        break;
                }

            }

            PlanItems = PlanItemsfromServer;
            await this.InvokeAsync(this.StateHasChanged);

        }
        catch (Exception ex)
        {

        }
    }

    private async void HandleChange(ChangeEventArgs args)
    {
        if (args.Value != null)
        {
            SelectedPlanKey = args.Value.ToString();
            Preferences.Set(StringConstants.SelectedPlanKey, SelectedPlanKey);
            var SelectedPlan = PlanItems.Where(plan => plan.UserSubscriptionPlanKey.ToString() == SelectedPlanKey).FirstOrDefault();
            await localCache.SaveItemInCache(StringConstants.SelectedPlanKey, SelectedPlan);
        }

    }

    private async void ValidateMembershipCode()
    {

        try
        {
            ApiResult<string> apiResult = null;
            apiResult = await this.apiService.UserSubscriptionTransactionOffer(new UserSubscriptionTransactionOfferRequest(App.CurrentUser.UserKey.ToString(), MemberShipCode));
            if (apiResult.Success)
            {
                await GetSubscription();
                App.DiscountCode = MemberShipCode;
                WeakReferenceMessenger.Default.Send<UpdatePlaneDetails>();
                await UpdateReferral();
                await Shell.Current.GoToAsync(nameof(RegisterSuccessPage));


                // await NavigationService.NavigateAsync(nameof(SignUpTermsPage));
            }
            else
            {
                await Application.Current.MainPage.DisplayAlert("Error", apiResult.Message, "OK");

            }
            // IsBusy = false;
        }
        catch (Exception ex)
        {
            //IsBusy = false;
        }

    }

    private async Task UpdateReferral()
    {
        try
        {
            var updateReferralRequest = new ReferralRequest(MemberShipCode, SelectedSchool);

            var output = await  apiService.UpdateCodeReferral(updateReferralRequest);
            if (output.Success)
            {
                // Successful update logic here if needed
            }
        }
        catch (Exception ex)
        {
            // Handle exceptions if necessary
        }
    }

    private async void GotoEcommerce()
    {
        if (string.IsNullOrEmpty(SelectedPlanKey)) return;
        await Shell.Current.GoToAsync(nameof(EcommercePage));

    }

    private async void GotoRegisterationSuccess()
    {
        if (NavigateFrom != null && NavigateFrom == "fromMore")
        {
            await Shell.Current.GoToAsync("..");
        }
        else
        {
            await Shell.Current.GoToAsync(nameof(RegisterSuccessPage));
        }
    }


    private async Task GetSubscription()
    {
        try
        {
            var userSubscriptionPlanRequest = new UserSubscriptionPlanRequest(App.CurrentUser.UserKey);
            var output = await this.apiService.AppUsersActiveSubscription(userSubscriptionPlanRequest);
            if (output.Success && output.Data != null && output.Data.Count > 0)
            {
                var Plandetails = output.Data[0];
                App.PlanDetails.IsActive = Plandetails.IsActive;
                await localCache.SaveItemInCache<PlanDetails>(LocalCacheKeys.PlanDetails, output.Data[0]);
                Preferences.Default.Set(StringConstants.IsPlanActive, output.Data[0].IsActive);
            }
        }
        catch (Exception ex)
        {

        }

    }

    public async Task GoBack()
    {
        await Shell.Current.GoToAsync("..");
    }

}
