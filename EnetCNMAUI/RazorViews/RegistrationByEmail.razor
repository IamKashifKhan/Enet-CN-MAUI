@inject IJSRuntime JSRuntime
@using EnetCNMAUI.Domain.Models
@using Plugin.Firebase.CloudMessaging;
@inject EmailRegistrationRequestValidator emailValidator
@inject IApiService apiService

<div class="main-wrap">

    <div class="nav-header bg-transparent shadow-none border-0">
        <div class="nav-top w-100">
            <a href="CN-index.html" class="mt-3"><img src="images/connect_now.svg" alt="" /> </a>
            <a href="CN_login.html" class="header-btn d-none d-lg-block bg-dark fw-500 text-white font-xsss p-3 ms-auto w100 text-center lh-20 rounded-xl">Login</a>
            <a href="CN-register.html" class="header-btn d-none d-lg-block bg-current fw-500 text-white font-xsss p-3 ms-2 w100 text-center lh-20 rounded-xl">Register</a>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-5 d-none d-xl-block p-0 vh-100 bg-image-cover bg-no-repeat" style="background-image: url(images/login-bg-2.jpg);"></div>
        <div class="col-xl-7 vh-100 align-items-center d-flex bg-white rounded-3 overflow-hidden">
            <div class="card shadow-none border-0 ms-auto me-auto login-card">
                <div class="card-body rounded-0 text-left ">
                    <h2 class="fw-700 display1-size display2-md-size mb-4">Create <br>your account</h2>

                    <form id="regForm" action="#">

                        <!-- Screen-1 -->
                        <div class="tab">
                            <h6>Your Email Address will be your Login</h6>
                            <p>Get the Verification Code in your email</p>
                            <div class="form-group icon-input mb-3">
                                <i class="font-sm ti-email text-grey-500 pe-0"></i>
                                <input @bind="email" type="text" class="style2-input ps-5 form-control text-grey-900 font-xsss fw-600" placeholder="Your Email Address">
                            </div>
                            <div class="form-group icon-input mb-3">
                                <i class="font-sm ti-user text-grey-500 pe-0"></i>
                                <input @bind="fullname" type="text" class="style2-input ps-5 form-control text-grey-900 font-xsss fw-600" placeholder="Your Name">
                            </div>
                        </div>

                        <!-- Screen-2 -->
                        <div class="tab">
                            <p>Enter Verification Code sent to Email/Phone <a href="#">Wrong Number or Email?</a></p>
                            <div class="form-group icon-input mb-3">
                                <i class="font-sm ti-key text-grey-500 pe-0"></i>
                                <input @bind="code" type="text" class="style2-input ps-5 form-control text-grey-900 font-xsss fw-600" placeholder="Enter 6-Digit Code">
                            </div>
                        </div>

                        <!-- Screen-3 -->
                        <div class="tab">
                            <div class="form-group icon-input mb-3">
                                <input id="password" type="password" class="style2-input ps-5 form-control text-grey-900 font-xss ls-3" placeholder="Password">
                                <i class="font-sm ti-lock text-grey-500 pe-0"></i>
                            </div>
                            <div class="form-group icon-input mb-1">
                                <input id="confirm-password" type="password" class="style2-input ps-5 form-control text-grey-900 font-xss ls-3" placeholder="Confirm Password">
                                <i class="font-sm ti-lock text-grey-500 pe-0"></i>
                            </div>

                            <div class="form-check text-left mb-3">
                                <input type="checkbox" class="form-check-input mt-2" id="exampleCheck2">
                                <label class="form-check-label font-xsss text-grey-500 mt-1 " for="exampleCheck2">Accept Term and Conditions</label>
                            </div>
                        </div>

                        <!-- Screen NAVIGATION -->
                        <div class="overflow-auto">
                            <div class="d-flex flex-row flex-nowrap justify-content-between">
                                <button type="button" id="prevBtn" @onclick="() =>nextPrev(-1)" class="text-center text-white fw-600 bg-dark border-0 p-2 px-3 rounded-4 rounded-xl">Previous</button>
                                <button type="button" id="nextBtn" @onclick="() =>nextPrev(1)" class="text-center text-white fw-600 bg-dark border-0 p-2 px-3 rounded-4 rounded-xl ml-auto">Next</button>
                            </div>
                        </div>
                        <div class="text-center mt-5">
                            <span class="step"></span>
                            <span class="step"></span>
                            <span class="step"></span>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@code {
    private IJSObjectReference? registrationByEmailJsRefernce;
    private DotNetObjectReference<RegistrationByEmail>? registrationByEmailDotnetReference;

    private string email;
    private string fullname;
    private string code;

    private UserModel user = new ();

    protected override async Task OnInitializedAsync()
    {
        registrationByEmailJsRefernce = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./RazorViews/RegistrationByEmail.razor.js");
        await JSRuntime.InvokeVoidAsync("Helpers.setDotNetHelper", DotNetObjectReference.Create(this));
        registrationByEmailDotnetReference = DotNetObjectReference.Create(this);
        SetupTabs();
        base.OnInitialized();
    }
    private async void SetupTabs()
    {
        await Task.Delay(200);
        await registrationByEmailJsRefernce.InvokeVoidAsync("initTabs");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

        }
        base.OnAfterRender(firstRender);
    }
    private int currenttab = 0;

    private async void nextPrev(int n)
    {
        //if (currenttab == 2 && n == 1) return;
        await registrationByEmailJsRefernce.InvokeVoidAsync("nextPrev", n, currenttab);
        currenttab = currenttab + n;
    }

    [JSInvokable("resetTabCount")]
    public Task resetTabCount(int n)
    {
        currenttab = currenttab - n;
        return Task.CompletedTask;
    }
    [JSInvokable("callApiService")]
    public async  Task callApiService(int n)
    {
        if (n == 1)
        {
            var registrationrequest = new EnetCNMAUI.Requests.User.EmailRegisterRequest {FullName= fullname, Email=email };
            var result = emailValidator.Validate(registrationrequest);
            if (result.IsValid)
            {
                var RegisterByEmailResult = await apiService.RegisterByEmail(registrationrequest);
            }
            else
            {
                currenttab = currenttab - 1;
            }
        }
        else if (n == 2)
        {
            var userVerificationByEmailRequest = new EnetCNMAUI.Requests.User.UserVerificationByEmailRequest { Email = email, VerificationCode = code };
            var userVerificationByEmailresult = await apiService.VerifyUserByEmail(userVerificationByEmailRequest);
            if (userVerificationByEmailresult.Success)
            {
                user = userVerificationByEmailresult.Data;
            }

        }
        else if (n == 3)
        {
            var setPasswordRequest = new EnetCNMAUI.Requests.User.SetPasswordRequest { Id = user.Id, NewPassword = code };
            var setPasswordResult = await apiService.SetPassword(setPasswordRequest);
            if (setPasswordResult.Success)
            {
                await Application.Current.MainPage.DisplayAlert("Success", "Account created successfully", "OK");

                await Shell.Current.GoToAsync("//LoginPage");
            }
        }
    }


}

