@using Microsoft.JSInterop
 
<button class="form-control text-start" type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#@_ids.ContainerId"
        aria-controls="@_ids.ContainerId">
    <span id="@_ids.HeaderSpanId">@_headerText</span>
 </button>

<div id="@_ids.ContainerId"
     class="offcanvas offcanvas-bottom rounded-4 rounded-bottom-0 px-0 shadow"
     data-bs-scroll="false" tabindex="-1">
    <div class="offcanvas-body d-flex flex-column justify-content-between">
        <!-- Selected Month/Year -->
        <div id="@_ids.PreviewId" class="fw-bold text-center mb-5">—</div>

        <!-- Scroll Pickers -->
        <div class="picker-wrapper">
            <div class="picker-highlight"></div>
            <div id="@_ids.MonthListId" class="picker-column"><ul></ul></div>
            <div id="@_ids.YearListId" class="picker-column"><ul></ul></div>
        </div>

        <!-- Buttons -->
        <div class="container d-none justify-content-between mt-5">
            <button class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            <button class="btn btn-outline-secondary" id="@_ids.SaveBtnId">Save</button>
        </div>
    </div>
</div>

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;

    /// <summary>How many years forward from StartDate to allow (default 10).</summary>
    [Parameter] public int Years { get; set; } = 10;

    /// <summary>Start date for initialization (defaults to now).</summary>
    [Parameter] public DateTime? StartDate { get; set; }

    /// <summary>Fires while the user scrolls and changes month/year.</summary>
    [Parameter] public EventCallback<MonthYearChangedArgs> OnChanged { get; set; }

    /// <summary>Fires when the user clicks Save.</summary>
    [Parameter] public EventCallback<MonthYearChangedArgs> OnSaved { get; set; }

    /// <summary>Optional: custom CSS for the trigger button.</summary>
    [Parameter]
    public string ButtonCss { get; set; }
        = "btn btn-sm bg-transparent text-body-emphasis border-0 w-auto mt-0 mb-2";

    private DotNetObjectReference<MonthYearPicker>? _dotRef;
    private (string ContainerId, string MonthListId, string YearListId,
             string PreviewId, string HeaderSpanId, string SaveBtnId) _ids;

    private string _headerText = "";

    protected override void OnInitialized()
    {
        // Generate unique IDs so multiple pickers can coexist
        var s = Guid.NewGuid().ToString("N");
        _ids = (
            ContainerId: $"offcanvasMonYrPicker_{s}",
            MonthListId: $"monthList_{s}",
            YearListId: $"yearList_{s}",
            PreviewId: $"selectedPreview_{s}",
            HeaderSpanId: $"txt_monthYear_{s}",
            SaveBtnId: $"savePicker_{s}"
        );

        var start = StartDate ?? DateTime.Now;
        _headerText = start.ToString("MMMM yyyy");
    }
    private IJSObjectReference? _pickerModule;
     protected override async Task OnAfterRenderAsync(bool firstRender)
    {
   
        if (!firstRender) return;

        _dotRef = DotNetObjectReference.Create(this);

        // 1) Import the module (path is relative to wwwroot)
        _pickerModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/monthYearPicker.js");

        var start = StartDate ?? DateTime.Now;

        var cfg = new
        {
            containerId = _ids.ContainerId,
            monthListId = _ids.MonthListId,
            yearListId = _ids.YearListId,
            previewId = _ids.PreviewId,
            headerId = _ids.HeaderSpanId,
            saveBtnId = _ids.SaveBtnId,
            liHeight = 44,
            buffer = 20,
            startYear = start.Year,
            startMonth = start.Month, // 1..12
            yearsForward = Years      // inclusive bound: startYear..startYear+Years
        };

        await _pickerModule.InvokeVoidAsync("init", cfg, _dotRef);
    }

    [JSInvokable]
    public async Task OnMonthYearChanged(int month1To12, int year)
    {
        _headerText = new DateTime(year, month1To12, 1).ToString("MMMM yyyy");
        await OnChanged.InvokeAsync(new MonthYearChangedArgs(year, month1To12));
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnMonthYearSaved(int month1To12, int year)
    {
        _headerText = new DateTime(year, month1To12, 1).ToString("MMMM yyyy");
        await OnSaved.InvokeAsync(new MonthYearChangedArgs(year, month1To12));
        StateHasChanged();
    }

    public void Dispose() => _dotRef?.Dispose();

    public readonly record struct MonthYearChangedArgs(int Year, int Month);
}
